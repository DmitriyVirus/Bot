import logging
from aiogram import Router, types
from aiogram.filters import Command
from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup

from tgbot.sheets.take_from_sheet import (
    get_info_column_by_header,
    get_bot_commands
)
from tgbot.handlers.kto import fetch_data_from_sheet  # –ò–º–ø–æ—Ä—Ç –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞

router = Router()
logger = logging.getLogger(__name__)


# ===== –ö–õ–ê–í–ò–ê–¢–£–†–´ =====

def create_main_menu():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üëΩ –£—á–∞—Å—Ç–Ω–∏–∫–∏ —á–∞—Ç–∞", callback_data="menu_participants")],
        [InlineKeyboardButton(text="ü§ñ –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –±–æ—Ç–∞", callback_data="menu_commands")],
        [InlineKeyboardButton(text="‚öôÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ", callback_data="menu_about_bot")]
    ])

def create_back_menu(back="back_to_main"):
    return InlineKeyboardMarkup(
        inline_keyboard=[[InlineKeyboardButton(text="üèÉ –ù–∞–∑–∞–¥", callback_data=back)]]
    )


# ===== –•–ï–ù–î–õ–ï–†–´ =====

@router.message(Command("bot"))
async def bot_menu(message: types.Message):
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ Hello –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∫–æ–º–∞–Ω–¥—ã /bot
    await message.answer(
        get_info_column_by_header("Hello"),
        reply_markup=create_main_menu(),
        parse_mode="Markdown"
    )


@router.callback_query(lambda c: c.data == "menu_participants")
async def participants(callback: types.CallbackQuery):
    client = get_gspread_client()
    if not client:
        await callback.message.edit_text("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Google Sheets.", reply_markup=create_back_menu())
        return

    expanded_table = fetch_data_from_sheet(client)
    if not expanded_table:
        await callback.message.edit_text("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets.", reply_markup=create_back_menu())
        return

    response = "–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:\n"
    for user_name, user_info in expanded_table.items():
        if user_name == user_info["name"].lower():
            response += (
                f"\n–ò–º—è: {user_info['name']}\n"
                f"{f'–ò–º—è –≤ —Ç–µ–ª–µ–≥—Ä–∞–º–º: {user_info['tgnick']}\n' if user_info['tgnick'] != 'Unknown' else ''}"
                f"{f'–ù–∏–∫: @{user_info['nick']}\n' if user_info['nick'] != 'Unknown' else ''}"
                f"–ò–Ω—Ñ–æ: {user_info['about']}\n"
            )

    await callback.message.edit_text(response, reply_markup=create_back_menu())


@router.callback_query(lambda c: c.data == "menu_commands")
async def commands(callback: types.CallbackQuery):
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ä–∞–∑—É –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
    await callback.message.edit_text(
        "\n".join(get_bot_commands()),
        reply_markup=create_back_menu()
    )


@router.callback_query(lambda c: c.data == "menu_about_bot")
async def about_bot(callback: types.CallbackQuery):
    await callback.message.edit_text(
        get_info_column_by_header("about_bot"),
        reply_markup=create_back_menu(),
        disable_web_page_preview=True
    )


@router.callback_query(lambda c: c.data == "back_to_main")
async def back(callback: types.CallbackQuery):
    await callback.message.edit_text(
        get_info_column_by_header("Hello"),
        reply_markup=create_main_menu()
    )
